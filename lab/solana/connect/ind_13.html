<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wallet & SOL Send Debug</title>

  <!-- Solana Web3.js -->
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.93.0/lib/index.iife.min.js"></script>

  <style>
    body { font-family: sans-serif; margin: 2rem; }
    select, button, input { margin: .5rem 0; padding: .5rem; font-size: 1rem; }
    #walletInfo { margin: 1rem 0; }
    #logs { white-space: pre-wrap; background: #f0f0f0; padding: 1rem; height: 200px; overflow: auto; }
  </style>
</head>
<body>
  <h2>Wallet verbinden</h2>
  <label for="walletSelect">Wallet:</label>
  <select id="walletSelect">
    <option value="phantom">Phantom (SOL)</option>
    <option value="solflare">Solflare (SOL)</option>
  </select>
  <button id="connectWallet">Verbinden</button>

  <p id="walletInfo">Nicht verbunden</p>
  <hr/>

  <h3>SOL senden</h3>
  <label for="solAmount">Anzahl SOL:</label>
  <input id="solAmount" type="number" step="0.01" min="0" value="0.01"/><br/>
  <button id="sendSol" disabled>SEND SOL</button>

  <h3>Logs</h3>
  <div id="logs"></div>

  <script>
    // Helfer fürs Logging
    function log(msg) {
      console.log(msg);
      const ln = document.createElement('div');
      ln.textContent = msg;
      document.getElementById('logs').appendChild(ln);
    }

    const { Connection, PublicKey, SystemProgram, Transaction, LAMPORTS_PER_SOL, clusterApiUrl } = solanaWeb3;
    let solProvider = null, solPublicKey = null, solConnection = null;

    document.getElementById('connectWallet').addEventListener('click', async () => {
      const choice = document.getElementById('walletSelect').value;
      log(`▶ Versuch, ${choice} zu verbinden...`);

      solProvider = null;
      solPublicKey = null;
      document.getElementById('sendSol').disabled = true;
      document.getElementById('walletInfo').innerText = 'Nicht verbunden';

      // Wähle den richtigen global object
      if (choice === 'phantom') {
        if (window.solana?.isPhantom) solProvider = window.solana;
      } else if (choice === 'solflare') {
        if (window.solflare) solProvider = window.solflare;
      }

      if (!solProvider) {
        alert(`${choice} Wallet nicht gefunden!`);
        log(`✖ ${choice} nicht vorhanden.`);
        return;
      }

      try {
        log('– rufe solProvider.connect() auf …');
        await solProvider.connect();
        solPublicKey = solProvider.publicKey;
        solConnection = new Connection(clusterApiUrl('mainnet-beta'), 'confirmed');
        document.getElementById('walletInfo').innerText = `${choice}: ${solPublicKey.toString()}`;
        document.getElementById('sendSol').disabled = false;
        log(`✔ Verbunden: ${solPublicKey.toString()}`);
        solProvider.on('disconnect', () => {
          log('⚠️ Wallet getrennt.');
          document.getElementById('walletInfo').innerText = 'Wallet getrennt';
          document.getElementById('sendSol').disabled = true;
        });
      } catch (e) {
        console.error(e);
        log(`✖ Fehler beim Verbinden: ${e.message || e}`);
      }
    });

    document.getElementById('sendSol').addEventListener('click', async () => {
      log('▶ SEND SOL Button geklickt');
      const amt = parseFloat(document.getElementById('solAmount').value);
      if (!solPublicKey) {
        log('✖ Kein PublicKey – bitte erst verbinden');
        return alert('Bitte erst eine Solana-Wallet verbinden.');
      }
      if (isNaN(amt) || amt <= 0) {
        log(`✖ Ungültiger Betrag: ${amt}`);
        return alert('Bitte gültige SOL-Menge eingeben.');
      }

      const recipient = new PublicKey('87rM7pH6PsUQ7zE7458XoD5K7od1heEuv1FyTguxenex');
      const lamports = Math.round(amt * LAMPORTS_PER_SOL);
      log(`– Erstelle Transfer: ${amt} SOL (${lamports} Lamports) an ${recipient}`);

      const tx = new Transaction().add(
        SystemProgram.transfer({
          fromPubkey: solPublicKey,
          toPubkey: recipient,
          lamports
        })
      );
      tx.feePayer = solPublicKey;
      try {
        const { blockhash } = await solConnection.getLatestBlockhash('confirmed');
        tx.recentBlockhash = blockhash;
        log(`– recentBlockhash gesetzt: ${blockhash}`);

        let signature;
        if (typeof solProvider.signAndSendTransaction === 'function') {
          log('– signAndSendTransaction() aufrufen …');
          ({ signature } = await solProvider.signAndSendTransaction(tx));
        } else {
          log('– signTransaction() aufrufen …');
          const signed = await solProvider.signTransaction(tx);
          log('– sende RawTransaction …');
          signature = await solConnection.sendRawTransaction(signed.serialize());
        }
        log(`✔ Signature erhalten: ${signature}`);
        log('– bestätige Transaktion …');
        await solConnection.confirmTransaction(signature, 'confirmed');
        log('🟢 Transaktion bestätigt!');
        alert(`Erfolgreich gesendet!\nSignature:\n${signature}`);
      } catch (e) {
        console.error(e);
        log(`✖ Fehler beim Senden: ${e.message || e}`);
        alert('Fehler beim Senden: ' + (e.message || e));
      }
    });
  </script>
</body>
</html>
