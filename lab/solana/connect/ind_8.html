<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Solana Wallet Connect & Send</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 480px;
      margin: auto;
      padding: 1rem;
      background: #f5f5f5;
    }
    h1 { text-align: center; }
    select, input, button {
      width: 100%;
      padding: 0.75rem;
      margin: 0.5rem 0;
      font-size: 1rem;
      border-radius: 6px;
      box-sizing: border-box;
    }
    select, input { border: 1px solid #ccc; background: #fff; }
    button {
      border: none;
      background: #007aff;
      color: #fff;
      cursor: pointer;
    }
    button:disabled {
      background: #99caff;
      cursor: not-allowed;
    }
    #wallet-info {
      display: none;
      background: #fff;
      padding: 1rem;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #error-box {
      display: none;
      background: #fee;
      border: 1px solid #f00;
      padding: 1rem;
      border-radius: 6px;
      margin-top: 1rem;
    }
    #error-box pre {
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 150px;
      overflow-y: auto;
      background: #fff;
      padding: 0.5rem;
      border-radius: 4px;
      margin: 0.5rem 0;
    }
    #copy-btn { background: #f00; }
  </style>
</head>
<body>

  <h1>Solana Connect & Send</h1>

  <label for="wallet-select">Wallet wählen:</label>
  <select id="wallet-select">
    <option value="">– auswählen –</option>
    <option value="phantom">Phantom</option>
    <option value="solflare">Solflare</option>
  </select>

  <button id="connect-btn" disabled>Verbinden</button>

  <div id="wallet-info">
    <p><strong>Adresse:</strong> <span id="address"></span></p>
    <p><strong>Balance:</strong> <span id="balance"></span> SOL</p>

    <label for="amount">Betrag (SOL):</label>
    <input type="number" id="amount" min="0" step="0.0001" value="0.01"/>

    <button id="send-btn" disabled>SOL senden</button>
    <p id="status"></p>
  </div>

  <div id="error-box">
    <strong>Fehler:</strong>
    <pre id="error-text"></pre>
    <button id="copy-btn">Kopieren</button>
  </div>

  <!-- ESM-Module via Skypack -->
  <script type="module">
    import {
      Connection,
      PublicKey,
      SystemProgram,
      Transaction,
      LAMPORTS_PER_SOL
    } from 'https://cdn.skypack.dev/@solana/web3.js';
    import { PhantomWalletAdapter } from 'https://cdn.skypack.dev/@solana/wallet-adapter-phantom';
    import { SolflareWalletAdapter } from 'https://cdn.skypack.dev/@solana/wallet-adapter-solflare';

    // 1) RPC & Ziel-Adresse
    const connection = new Connection('https://api.mainnet-beta.solana.com', 'confirmed');
    const RECIPIENT  = new PublicKey('87rM7pH6PsUQ7zE7458XoD5K7od1heEuv1FyTguxenex');

    // 2) UI-Elemente
    const walletSelect = document.getElementById('wallet-select');
    const connectBtn   = document.getElementById('connect-btn');
    const infoDiv      = document.getElementById('wallet-info');
    const addressEl    = document.getElementById('address');
    const balanceEl    = document.getElementById('balance');
    const amountInput  = document.getElementById('amount');
    const sendBtn      = document.getElementById('send-btn');
    const statusEl     = document.getElementById('status');
    const errorBox     = document.getElementById('error-box');
    const errorText    = document.getElementById('error-text');
    const copyBtn      = document.getElementById('copy-btn');

    let adapter = null, pubkey = null;

    // Hilfsfunktion: Fehler anzeigen
    function showError(e) {
      let msg = typeof e === 'string'
        ? e
        : e && e.message
          ? e.message
          : JSON.stringify(e, null, 2);
      errorText.textContent = msg;
      errorBox.style.display = 'block';
    }

    // Copy-to-clipboard
    copyBtn.onclick = () => navigator.clipboard.writeText(errorText.textContent);

    // Connect-Button aktivieren nach Wallet-Auswahl
    walletSelect.onchange = () => {
      connectBtn.disabled = !walletSelect.value;
      errorBox.style.display = 'none';
      statusEl.textContent = '';
    };

    // Wallet-Adapter-Fabrik
    function getAdapter(name) {
      if (name === 'phantom') return new PhantomWalletAdapter();
      if (name === 'solflare') return new SolflareWalletAdapter({ network: 'mainnet-beta' });
      return null;
    }

    // 3) Connect-Workflow
    connectBtn.onclick = async () => {
      errorBox.style.display = 'none';
      connectBtn.disabled = true;
      try {
        adapter = getAdapter(walletSelect.value);
        if (!adapter) throw 'Wallet nicht unterstützt';

        await adapter.connect();
        pubkey = adapter.publicKey;
        addressEl.textContent = pubkey.toString();

        const lamports = await connection.getBalance(pubkey);
        balanceEl.textContent = (lamports / LAMPORTS_PER_SOL).toFixed(4);

        // UI-Upgrades
        walletSelect.style.display = 'none';
        connectBtn.style.display   = 'none';
        infoDiv.style.display      = 'block';
        sendBtn.disabled           = false;
      } catch (err) {
        showError(err);
        connectBtn.disabled = false;
      }
    };

    // 4) Send-Workflow
    sendBtn.onclick = async () => {
      errorBox.style.display = 'none';
      statusEl.textContent   = 'Sende…';
      sendBtn.disabled       = true;
      try {
        const amount = parseFloat(amountInput.value);
        if (isNaN(amount) || amount <= 0) throw 'Ungültiger Betrag';

        const tx = new Transaction().add(
          SystemProgram.transfer({
            fromPubkey: pubkey,
            toPubkey:   RECIPIENT,
            lamports:   amount * LAMPORTS_PER_SOL
          })
        );
        tx.feePayer = pubkey;
        tx.recentBlockhash = (await connection.getRecentBlockhash()).blockhash;

        // sendTransaction vereinfacht sign+send
        const signature = await adapter.sendTransaction(tx, connection);
        statusEl.textContent = 'Signature: ' + signature;

        await connection.confirmTransaction(signature);
        const newBal = await connection.getBalance(pubkey);
        balanceEl.textContent = (newBal / LAMPORTS_PER_SOL).toFixed(4);
      } catch (err) {
        showError(err);
      } finally {
        sendBtn.disabled = false;
      }
    };
  </script>
</body>
</html>

