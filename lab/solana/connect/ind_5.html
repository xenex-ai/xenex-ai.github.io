<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Solana Multi-Wallet Connect</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1rem;
      max-width: 480px;
      margin: auto;
      background: #f9f9f9;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }
    select, input[type="number"], button {
      width: 100%;
      padding: 0.75rem;
      margin: 0.5rem 0;
      font-size: 1rem;
      border-radius: 6px;
      box-sizing: border-box;
    }
    select, input[type="number"] {
      border: 1px solid #ccc;
      background: #fff;
    }
    button {
      border: none;
      background: #0055ff;
      color: #fff;
      cursor: pointer;
    }
    button:disabled {
      background: #99b3ff;
      cursor: not-allowed;
    }
    #wallet-info {
      display: none;
      background: #fff;
      padding: 1rem;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-top: 1rem;
    }
    p { margin: 0.5rem 0; word-break: break-all; }
    #status {
      color: green;
      word-break: break-all;
    }
    #error-container {
      display: none;
      background: #ffe6e6;
      border: 1px solid #ff4d4d;
      padding: 1rem;
      border-radius: 6px;
      margin-top: 1rem;
    }
    #error-container pre {
      max-height: 150px;
      overflow-y: auto;
      background: #fff;
      padding: 0.5rem;
      border-radius: 4px;
      word-break: break-all;
      margin: 0.5rem 0;
    }
    #copy-btn {
      background: #ff4d4d;
    }
  </style>
  <!-- Solana Web3.js via CDN -->
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
</head>
<body>
  <h1>Solana Multi-Wallet Demo</h1>

  <!-- Wallet-Auswahl -->
  <label for="wallet-select"><strong>Wallet wählen:</strong></label>
  <select id="wallet-select">
    <option value="">––– auswählen –––</option>
    <option value="phantom">Phantom</option>
    <option value="solflare">Solflare</option>
  </select>

  <!-- Connect Button -->
  <button id="connect-btn" disabled>Mit Wallet verbinden</button>

  <!-- Wallet-Info -->
  <div id="wallet-info">
    <p><strong>Adresse:</strong> <span id="address"></span></p>
    <p><strong>Balance:</strong> <span id="balance"></span> SOL</p>

    <label for="amount"><strong>Betrag (SOL):</strong></label>
    <input type="number" id="amount" min="0" step="0.0001" value="0.01">

    <button id="send-btn">SOL senden</button>
    <p id="status"></p>
  </div>

  <!-- Fehleranzeige -->
  <div id="error-container">
    <strong>Fehler:</strong>
    <pre id="error-text"></pre>
    <button id="copy-btn">In Zwischenablage kopieren</button>
  </div>

  <script>
    (async () => {
      const {
        Connection,
        PublicKey,
        SystemProgram,
        Transaction,
        LAMPORTS_PER_SOL
      } = solanaWeb3;

      // CORS-freundliches RPC
      const connection = new Connection("https://solana-api.projectserum.com", "confirmed");
      const recipient  = new PublicKey("87rM7pH6PsUQ7zE7458XoD5K7od1heEuv1FyTguxenex");

      // DOM-Elemente
      const walletSelect = document.getElementById("wallet-select");
      const connectBtn   = document.getElementById("connect-btn");
      const walletInfo   = document.getElementById("wallet-info");
      const addressEl    = document.getElementById("address");
      const balanceEl    = document.getElementById("balance");
      const amountInput  = document.getElementById("amount");
      const sendBtn      = document.getElementById("send-btn");
      const statusEl     = document.getElementById("status");
      const errorCon     = document.getElementById("error-container");
      const errorText    = document.getElementById("error-text");
      const copyBtn      = document.getElementById("copy-btn");

      let provider = null;
      let pubkey   = null;

      // Fehlermeldung anzeigen
      function showError(e) {
        let txt = typeof e === "string"
          ? e
          : e && e.message
            ? e.message
            : JSON.stringify(e, null, 2);
        errorText.textContent = txt;
        errorCon.style.display = "block";
      }

      // Fehler kopieren
      copyBtn.onclick = () => {
        navigator.clipboard.writeText(errorText.textContent)
          .then(() => alert("Fehler kopiert!"))
          .catch(e => alert("Kopieren fehlgeschlagen: " + e));
      };

      // Aktivieren des Connect-Buttons, wenn eine Auswahl getroffen wurde
      walletSelect.onchange = () => {
        connectBtn.disabled = walletSelect.value === "";
        errorCon.style.display = "none";
      };

      // Wallet verbinden
      connectBtn.onclick = async () => {
        errorCon.style.display = "none";
        statusEl.textContent   = "";
        connectBtn.disabled     = true;

        // Provider je nach Auswahl
        const choice = walletSelect.value;
        if (choice === "phantom") {
          if (!window.solana || !window.solana.isPhantom) {
            showError("Phantom nicht gefunden. Bitte Phantom installieren.");
            connectBtn.disabled = false;
            return;
          }
          provider = window.solana;
        } else if (choice === "solflare") {
          if (!window.solflare) {
            showError("Solflare nicht gefunden. Bitte Solflare installieren.");
            connectBtn.disabled = false;
            return;
          }
          provider = window.solflare;  // Solflare-API ist weitgehend kompatibel
        } else {
          showError("Unbekannte Wallet-Auswahl.");
          connectBtn.disabled = false;
          return;
        }

        try {
          // Connect
          const resp = await provider.connect();
          pubkey = resp.publicKey || provider.publicKey;
          addressEl.textContent = pubkey.toString();

          // Balance abfragen
          const lamports = await connection.getBalance(pubkey);
          balanceEl.textContent = (lamports / LAMPORTS_PER_SOL).toFixed(4);

          // UI umschalten
          connectBtn.style.display = "none";
          walletSelect.style.display = "none";
          walletInfo.style.display = "block";
        } catch (err) {
          showError(err);
          connectBtn.disabled = false;
        }
      };

      // SOL senden
      sendBtn.onclick = async () => {
        errorCon.style.display = "none";
        statusEl.textContent   = "Vorbereitung…";
        sendBtn.disabled       = true;

        const amount = parseFloat(amountInput.value);
        if (isNaN(amount) || amount <= 0) {
          showError("Ungültiger Betrag.");
          sendBtn.disabled = false;
          statusEl.textContent = "";
          return;
        }

        try {
          // Transaktion bauen
          const tx = new Transaction().add(
            SystemProgram.transfer({
              fromPubkey: pubkey,
              toPubkey:   recipient,
              lamports:   amount * LAMPORTS_PER_SOL
            })
          );
          tx.feePayer = pubkey;
          const { blockhash } = await connection.getRecentBlockhash();
          tx.recentBlockhash = blockhash;

          // Sign & Send
          let signed;
          try {
            signed = await provider.signAndSendTransaction(tx);
          } catch (signErr) {
            throw { stage: "signAndSendTransaction", detail: signErr };
          }

          statusEl.textContent = "Gesendet! Signature: " + signed.signature;

          // Confirm
          await connection.confirmTransaction(signed.signature);

          // Balance neu holen
          const newBal = await connection.getBalance(pubkey);
          balanceEl.textContent = (newBal / LAMPORTS_PER_SOL).toFixed(4);

        } catch (err) {
          showError(err);
        } finally {
          sendBtn.disabled = false;
        }
      };
    })();
  </script>
</body>
</html>
