<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Solana Wallet Connect (optimiert)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1rem;
      max-width: 480px;
      margin: auto;
      background: #f9f9f9;
      color: #333;
    }
    h1 {
      font-size: 1.5rem;
      text-align: center;
      margin-bottom: 1rem;
    }
    button {
      display: block;
      width: 100%;
      padding: 0.75rem;
      margin: 0.5rem 0;
      font-size: 1rem;
      border: none;
      border-radius: 6px;
      background-color: #0055ff;
      color: #fff;
      cursor: pointer;
    }
    button:disabled {
      background-color: #99b3ff;
      cursor: not-allowed;
    }
    input[type="number"] {
      width: 100%;
      padding: 0.75rem;
      margin: 0.5rem 0;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    #wallet-info {
      margin-top: 1rem;
      background: #fff;
      padding: 1rem;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    p { margin: 0.5rem 0; word-break: break-all; }
    #status {
      margin-top: 0.5rem;
      color: green;
      word-break: break-all;
    }
    #error-container {
      display: none;
      margin-top: 1rem;
      background: #ffe6e6;
      border: 1px solid #ff4d4d;
      padding: 1rem;
      border-radius: 6px;
    }
    #error-container pre {
      max-height: 150px;
      overflow-y: auto;
      background: #fff;
      padding: 0.5rem;
      border-radius: 4px;
      word-break: break-all;
      margin: 0.5rem 0;
    }
    #copy-btn {
      background: #ff4d4d;
    }
  </style>
  <!-- Solana-Web3.js über CDN -->
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
</head>
<body>
  <h1>Solana Wallet Connect</h1>

  <button id="connect-btn" disabled>
    Auf Wallet warten…
  </button>

  <div id="wallet-info" style="display: none;">
    <p><strong>Adresse:</strong> <span id="address"></span></p>
    <p><strong>Balance:</strong> <span id="balance"></span> SOL</p>

    <label for="amount"><strong>Betrag (SOL):</strong></label>
    <input type="number" id="amount" min="0" step="0.0001" value="0.01">

    <button id="send-btn">SOL senden</button>
    <p id="status"></p>
  </div>

  <div id="error-container">
    <strong>Fehler:</strong>
    <pre id="error-text"></pre>
    <button id="copy-btn">In Zwischenablage kopieren</button>
  </div>

  <script>
  (async () => {
    const { Connection, PublicKey, SystemProgram, Transaction, LAMPORTS_PER_SOL } = solanaWeb3;
    const RPC_ENDPOINT = "https://solana-api.projectserum.com";
    const connection   = new Connection(RPC_ENDPOINT, "confirmed");

    const connectBtn     = document.getElementById("connect-btn");
    const infoDiv        = document.getElementById("wallet-info");
    const addrSpan       = document.getElementById("address");
    const balSpan        = document.getElementById("balance");
    const amtInput       = document.getElementById("amount");
    const sendBtn        = document.getElementById("send-btn");
    const statusP        = document.getElementById("status");
    const errorContainer = document.getElementById("error-container");
    const errorText      = document.getElementById("error-text");
    const copyBtn        = document.getElementById("copy-btn");

    let provider = null;

    // Fehlermeldung anzeigen
    function showError(e) {
      let txt;
      if (typeof e === 'string') txt = e;
      else if (e && e.message) txt = e.message;
      else txt = JSON.stringify(e, null, 2);
      errorText.textContent = txt;
      errorContainer.style.display = 'block';
    }

    // Fehler kopieren
    copyBtn.onclick = () => {
      navigator.clipboard.writeText(errorText.textContent)
        .then(() => alert('Fehler kopiert!'))
        .catch(e => alert('Kopieren fehlgeschlagen: ' + e));
    };

    // Auf Wallet-Injektion warten (max. 10 s)
    let attempts = 0;
    const maxAttempts = 20;
    const interval = setInterval(() => {
      if (window.solana && window.solana.isPhantom) {
        provider = window.solana;
        clearInterval(interval);
        connectBtn.textContent = 'Mit Wallet verbinden';
        connectBtn.disabled = false;
      } else if (++attempts >= maxAttempts) {
        clearInterval(interval);
        showError('Keine Phantom-Wallet gefunden. Bitte installiere Phantom.');
        connectBtn.textContent = 'Wallet nicht verfügbar';
      }
    }, 500);

    // Connect-Button
    connectBtn.onclick = async () => {
      errorContainer.style.display = 'none';
      statusP.textContent = '';
      connectBtn.disabled = true;
      try {
        const resp = await provider.connect();
        const pubKey = resp.publicKey;
        addrSpan.textContent = pubKey.toString();

        let lamports;
        try {
          lamports = await connection.getBalance(pubKey);
        } catch (rpcErr) {
          throw { stage: 'getBalance', detail: rpcErr.message || rpcErr };
        }
        balSpan.textContent = (lamports / LAMPORTS_PER_SOL).toFixed(4);

        connectBtn.style.display = 'none';
        infoDiv.style.display   = 'block';
      } catch (err) {
        showError(err);
        connectBtn.disabled = false;
      }
    };

    // Send-Button
    sendBtn.onclick = async () => {
      errorContainer.style.display = 'none';
      statusP.textContent = 'Vorbereiten…';
      sendBtn.disabled = true;

      const amount = parseFloat(amtInput.value);
      if (isNaN(amount) || amount <= 0) {
        showError('Ungültiger Betrag.');
        sendBtn.disabled = false;
        statusP.textContent = '';
        return;
      }

      try {
        const tx = new Transaction().add(
          SystemProgram.transfer({
            fromPubkey: provider.publicKey,
            toPubkey:   new PublicKey("87rM7pH6PsUQ7zE7458XoD5K7od1heEuv1FyTguxenex"),
            lamports:   amount * LAMPORTS_PER_SOL
          })
        );
        tx.feePayer = provider.publicKey;
        const { blockhash } = await connection.getRecentBlockhash();
        tx.recentBlockhash = blockhash;

        let result;
        try {
          result = await provider.signAndSendTransaction(tx);
        } catch (signErr) {
          throw { stage: 'signAndSendTransaction', detail: signErr.message || signErr };
        }

        statusP.textContent = "Gesendet! Signature: " + result.signature;

        try {
          await connection.confirmTransaction(result.signature);
        } catch (confErr) {
          throw { stage: 'confirmTransaction', detail: confErr.message || confErr };
        }

        const newBal = await connection.getBalance(provider.publicKey);
        balSpan.textContent = (newBal / LAMPORTS_PER_SOL).toFixed(4);

      } catch (err) {
        showError(err);
      } finally {
        sendBtn.disabled = false;
      }
    };
  })();
  </script>
</body>
</html>

