<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Solana Wallet Demo (mobil optimiert)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1rem;
      max-width: 480px;
      margin: auto;
      background: #f9f9f9;
      color: #333;
    }
    h1 {
      font-size: 1.5rem;
      text-align: center;
    }
    button {
      display: block;
      width: 100%;
      padding: 0.75rem;
      margin: 0.5rem 0;
      font-size: 1rem;
      border: none;
      border-radius: 6px;
      background-color: #0055ff;
      color: #fff;
    }
    button:disabled {
      background-color: #99b3ff;
    }
    input[type="number"] {
      width: 100%;
      padding: 0.75rem;
      margin: 0.5rem 0;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    #wallet-info {
      margin-top: 1rem;
      background: #fff;
      padding: 1rem;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    p { margin: 0.5rem 0; }
    #status {
      margin-top: 0.5rem;
      color: green;
      word-break: break-all;
    }
    #error-container {
      display: none;
      margin-top: 1rem;
      background: #ffe6e6;
      border: 1px solid #ff4d4d;
      padding: 1rem;
      border-radius: 6px;
    }
    #error-container pre {
      max-height: 150px;
      overflow-y: auto;
      background: #fff;
      padding: 0.5rem;
      border-radius: 4px;
      word-break: break-all;
    }
    #copy-btn {
      background: #ff4d4d;
      margin-top: 0.5rem;
    }
  </style>

  <!-- Solana-Web3.js via CDN -->
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
</head>
<body>
  <h1>Solana Wallet Demo</h1>

  <button id="connect-btn">Mit Wallet verbinden</button>

  <div id="wallet-info" style="display: none;">
    <p><strong>Adresse:</strong> <span id="address"></span></p>
    <p><strong>Balance:</strong> <span id="balance"></span> SOL</p>

    <label for="amount"><strong>Betrag (SOL):</strong></label>
    <input type="number" id="amount" min="0" step="0.0001" value="0.01">

    <button id="send-btn">SOL senden</button>
    <p id="status"></p>
  </div>

  <div id="error-container">
    <strong>Fehlermeldung:</strong>
    <pre id="error-text"></pre>
    <button id="copy-btn">Fehler kopieren</button>
  </div>

  <script>
  (async () => {
    // Prüfen auf Phantom-kompatible Wallet
    const provider = window.solana;
    if (!provider || !provider.isPhantom) {
      showError('Keine Phantom-kompatible Solana-Wallet erkannt. Bitte Phantom installieren.');
      return;
    }

    // Web3-Klassen
    const { Connection, PublicKey, SystemProgram, Transaction, LAMPORTS_PER_SOL } = solanaWeb3;

    // CORS-friendly RPC
    const RPC_ENDPOINT = "https://solana-api.projectserum.com";
    const connection   = new Connection(RPC_ENDPOINT, "confirmed");

    // DOM-Elemente
    const connectBtn     = document.getElementById("connect-btn");
    const infoDiv        = document.getElementById("wallet-info");
    const addrSpan       = document.getElementById("address");
    const balSpan        = document.getElementById("balance");
    const amtInput       = document.getElementById("amount");
    const sendBtn        = document.getElementById("send-btn");
    const statusP        = document.getElementById("status");
    const errorContainer = document.getElementById("error-container");
    const errorText      = document.getElementById("error-text");
    const copyBtn        = document.getElementById("copy-btn");

    // Zeigt Fehler an
    function showError(err) {
      let txt;
      if (typeof err === 'string') {
        txt = err;
      } else if (err && err.message) {
        txt = err.message;
      } else {
        try { txt = JSON.stringify(err, null, 2); }
        catch { txt = String(err); }
      }
      errorText.textContent = txt;
      errorContainer.style.display = 'block';
    }

    // Kopieren-Button
    copyBtn.onclick = () => {
      navigator.clipboard.writeText(errorText.textContent)
        .then(() => alert('Fehler kopiert'))
        .catch(e => alert('Kopieren fehlgeschlagen: ' + e));
    };

    // Wallet verbinden
    connectBtn.onclick = async () => {
      errorContainer.style.display = 'none';
      statusP.textContent = '';
      connectBtn.disabled = true;
      try {
        const resp = await provider.connect();
        const pubKey = resp.publicKey;
        addrSpan.textContent = pubKey.toString();

        let lamports;
        try {
          lamports = await connection.getBalance(pubKey);
        } catch (rpcErr) {
          throw { stage: 'getBalance', detail: rpcErr.message || rpcErr };
        }
        balSpan.textContent = (lamports / LAMPORTS_PER_SOL).toFixed(4);

        connectBtn.style.display = 'none';
        infoDiv.style.display   = 'block';
      } catch (err) {
        showError(err);
        connectBtn.disabled = false;
      }
    };

    // SOL senden
    sendBtn.onclick = async () => {
      errorContainer.style.display = 'none';
      statusP.textContent = 'Vorbereitung läuft…';
      sendBtn.disabled = true;

      const amount = parseFloat(amtInput.value);
      if (isNaN(amount) || amount <= 0) {
        showError('Ungültiger Betrag.');
        sendBtn.disabled = false;
        statusP.textContent = '';
        return;
      }

      try {
        // TX bauen
        const tx = new Transaction().add(
          SystemProgram.transfer({
            fromPubkey: provider.publicKey,
            toPubkey:   new PublicKey("87rM7pH6PsUQ7zE7458XoD5K7od1heEuv1FyTguxenex"),
            lamports:   amount * LAMPORTS_PER_SOL
          })
        );
        tx.feePayer = provider.publicKey;
        const { blockhash } = await connection.getRecentBlockhash();
        tx.recentBlockhash = blockhash;

        // Sign & Send
        let result;
        try {
          result = await provider.signAndSendTransaction(tx);
        } catch (signErr) {
          throw { stage: 'signAndSendTransaction', detail: signErr.message || signErr };
        }

        statusP.textContent = "Gesendet, Signature: " + result.signature;

        // Confirm
        try {
          await connection.confirmTransaction(result.signature);
        } catch (confErr) {
          throw { stage: 'confirmTransaction', detail: confErr.message || confErr };
        }

        // Balance aktualisieren
        const lamportsNew = await connection.getBalance(provider.publicKey);
        balSpan.textContent = (lamportsNew / LAMPORTS_PER_SOL).toFixed(4);
      } catch (err) {
        showError(err);
      } finally {
        sendBtn.disabled = false;
      }
    };

  })();
  </script>
</body>
</html>
