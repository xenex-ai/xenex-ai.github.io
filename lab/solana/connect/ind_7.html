<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Solana Wallet Adapter Demo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0 auto;
      padding: 1rem;
      max-width: 480px;
      background: #f5f5f5;
      color: #333;
    }
    h1 { text-align:center; margin-bottom:1rem; }
    select, input, button {
      width:100%; padding:0.75rem; margin:0.5rem 0; font-size:1rem; border-radius:6px; box-sizing:border-box;
    }
    select, input { border:1px solid #ccc; background:#fff; }
    button {
      border:none; background:#007aff; color:#fff; cursor:pointer;
    }
    button:disabled { background:#99caff; cursor:not-allowed; }
    #wallet-info {
      display:none; background:#fff; padding:1rem; border-radius:6px;
      box-shadow:0 2px 4px rgba(0,0,0,0.1); margin-top:1rem;
    }
    p { margin:0.5rem 0; word-break:break-all; }
    #status { color:green; }
    #error-box {
      display:none; background:#ffe6e6; border:1px solid #ff4d4d;
      padding:1rem; border-radius:6px; margin-top:1rem;
    }
    #error-box pre {
      max-height:120px; overflow-y:auto; background:#fff; padding:0.5rem;
      border-radius:4px; word-break:break-all; margin:0.5rem 0;
    }
    #copy-btn { background:#ff4d4d; }
  </style>
</head>
<body>
  <h1>Solana Wallet Adapter</h1>

  <label for="wallet-select"><strong>Wallet wählen:</strong></label>
  <select id="wallet-select">
    <option value="">– auswählen –</option>
    <option value="phantom">Phantom</option>
    <option value="solflare">Solflare</option>
    <option value="torus">Torus</option>
    <option value="backpack">Backpack</option>
  </select>

  <button id="connect-btn" disabled>Verbinden</button>

  <div id="wallet-info">
    <p><strong>Adresse:</strong> <span id="address"></span></p>
    <p><strong>Balance:</strong> <span id="balance"></span> SOL</p>
    <label for="amount"><strong>Betrag (SOL):</strong></label>
    <input type="number" id="amount" min="0" step="0.0001" value="0.01"/>
    <button id="send-btn" disabled>SOL senden</button>
    <p id="status"></p>
  </div>

  <div id="error-box">
    <strong>Fehler:</strong>
    <pre id="error-text"></pre>
    <button id="copy-btn">Kopieren</button>
  </div>

  <script type="module">
    import {
      Connection,
      PublicKey,
      SystemProgram,
      Transaction,
      LAMPORTS_PER_SOL
    } from 'https://cdn.skypack.dev/@solana/web3.js';
    import {
      PhantomWalletAdapter,
      SolflareWalletAdapter,
      TorusWalletAdapter,
      BackpackWalletAdapter
    } from 'https://cdn.skypack.dev/@solana/wallet-adapter-wallets';

    // 1) Setup RPC & Empfänger
    const connection = new Connection('https://solana-api.projectserum.com', 'confirmed');
    const RECIPIENT  = new PublicKey('87rM7pH6PsUQ7zE7458XoD5K7od1heEuv1FyTguxenex');

    // 2) UI-Elemente
    const walletSelect = document.getElementById('wallet-select');
    const connectBtn   = document.getElementById('connect-btn');
    const infoDiv      = document.getElementById('wallet-info');
    const addrSpan     = document.getElementById('address');
    const balSpan      = document.getElementById('balance');
    const amtInput     = document.getElementById('amount');
    const sendBtn      = document.getElementById('send-btn');
    const statusP      = document.getElementById('status');
    const errorBox     = document.getElementById('error-box');
    const errorText    = document.getElementById('error-text');
    const copyBtn      = document.getElementById('copy-btn');

    let adapter = null, pubkey = null;

    // Fehleranzeige
    function showError(e) {
      const txt = typeof e === 'string'
        ? e
        : e && e.message
          ? e.message
          : JSON.stringify(e, null, 2);
      errorText.textContent = txt;
      errorBox.style.display = 'block';
    }

    // Kopier-Button
    copyBtn.onclick = () => navigator.clipboard.writeText(errorText.textContent);

    // Connect-Button aktivieren
    walletSelect.onchange = () => {
      connectBtn.disabled = !walletSelect.value;
      errorBox.style.display = 'none';
    };

    // Wallet-Adapter Factory
    function getAdapter(name) {
      switch (name) {
        case 'phantom':  return new PhantomWalletAdapter();
        case 'solflare': return new SolflareWalletAdapter({ network: 'mainnet-beta' });
        case 'torus':    return new TorusWalletAdapter();
        case 'backpack': return new BackpackWalletAdapter();
        default: return null;
      }
    }

    // 3) Wallet verbinden
    connectBtn.onclick = async () => {
      errorBox.style.display = 'none';
      connectBtn.disabled = true;
      sendBtn.disabled   = true;
      try {
        adapter = getAdapter(walletSelect.value);
        if (!adapter) throw 'Wallet nicht unterstützt';
        await adapter.connect();  // SDK-intern: requestConnection() usw. :contentReference[oaicite:0]{index=0}
        pubkey = adapter.publicKey;
        addrSpan.textContent = pubkey.toString();

        const lamports = await connection.getBalance(pubkey);
        balSpan.textContent = (lamports / LAMPORTS_PER_SOL).toFixed(4);

        walletSelect.style.display = 'none';
        connectBtn.style.display   = 'none';
        infoDiv.style.display      = 'block';
        sendBtn.disabled           = false;
      } catch (err) {
        showError(err);
        connectBtn.disabled = false;
      }
    };

    // 4) SOL senden
    sendBtn.onclick = async () => {
      errorBox.style.display = 'none';
      statusP.textContent    = '';
      sendBtn.disabled       = true;
      const amount = parseFloat(amtInput.value);
      if (isNaN(amount) || amount <= 0) {
        showError('Ungültiger Betrag');
        sendBtn.disabled = false;
        return;
      }
      try {
        const tx = new Transaction().add(
          SystemProgram.transfer({
            fromPubkey: pubkey,
            toPubkey:   RECIPIENT,
            lamports:   amount * LAMPORTS_PER_SOL
          })
        );
        tx.feePayer        = pubkey;
        tx.recentBlockhash = (await connection.getRecentBlockhash()).blockhash;

        // sendTransaction signiert & sendet in einem Schritt :contentReference[oaicite:1]{index=1}
        const signature = await adapter.sendTransaction(tx, connection);
        statusP.textContent = 'Gesendet: ' + signature;

        await connection.confirmTransaction(signature);
        const newBal = await connection.getBalance(pubkey);
        balSpan.textContent = (newBal / LAMPORTS_PER_SOL).toFixed(4);
      } catch (err) {
        showError(err);
      } finally {
        sendBtn.disabled = false;
      }
    };
  </script>
</body>
</html>
