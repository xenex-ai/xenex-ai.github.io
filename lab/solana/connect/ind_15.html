<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Phantom SOL Send Debug</title>

  <!-- Solana Web3.js -->
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.93.0/lib/index.iife.min.js"></script>

  <style>
    body { font-family: sans-serif; margin: 2rem; }
    select, button, input { margin: .5rem 0; padding: .5rem; font-size: 1rem; }
    #walletInfo { margin: 1rem 0; color: #036; }
    #logs { white-space: pre-wrap; background: #f0f0f0; padding: 1rem; height: 200px; overflow: auto; }
  </style>
</head>
<body>
  <h2>Phantom Debug SOL Send</h2>

  <button id="connectPhantom">Phantom verbinden</button>
  <p id="walletInfo">Nicht verbunden</p>
  <hr/>

  <h3>SOL senden</h3>
  <label for="solAmount">Anzahl SOL:</label>
  <input id="solAmount" type="number" step="0.001" min="0" value="0.01"/><br/>
  <button id="sendSol" disabled>SEND SOL</button>

  <h3>Logs</h3>
  <div id="logs"></div>

  <script>
    // Helfer fürs Logging
    function log(msg) {
      console.log(msg);
      const ln = document.createElement('div');
      ln.textContent = msg;
      document.getElementById('logs').appendChild(ln);
    }

    // Solana-Web3 Elemente
    const { Connection, PublicKey, SystemProgram, Transaction, LAMPORTS_PER_SOL, clusterApiUrl } = solanaWeb3;
    let solProvider = null, solPublicKey = null, solConnection = null;

    document.getElementById('connectPhantom').addEventListener('click', async () => {
      log('▶ Phantom verbinden …');
      if (!window.solana?.isPhantom) {
        log('✖ window.solana.isPhantom fehlt');
        return alert('Phantom Wallet nicht installiert!');
      }
      try {
        solProvider = window.solana;
        log('– Aufruf: solProvider.connect()');
        await solProvider.connect();
        solPublicKey = solProvider.publicKey;
        solConnection = new Connection(clusterApiUrl('mainnet-beta'), 'confirmed');
        document.getElementById('walletInfo').innerText = `Phantom: ${solPublicKey}`;
        document.getElementById('sendSol').disabled = false;
        log(`✔ Verbunden: ${solPublicKey.toString()}`);
      } catch (e) {
        console.error(e);
        log(`✖ Fehler beim Verbinden: ${e.message || e}`);
      }
    });

    document.getElementById('sendSol').addEventListener('click', async () => {
      log('▶ SEND SOL geklickt');
      const amt = parseFloat(document.getElementById('solAmount').value);
      if (!solPublicKey) {
        log('✖ Kein PublicKey – bitte verbinden');
        return alert('Bitte erst Phantom verbinden.');
      }
      if (isNaN(amt) || amt <= 0) {
        log(`✖ Ungültige Menge: ${amt}`);
        return alert('Bitte gültige SOL-Menge.');
      }

      const recipient = new PublicKey('87rM7pH6PsUQ7zE7458XoD5K7od1heEuv1FyTguxenex');
      const lamports = Math.round(amt * LAMPORTS_PER_SOL);
      log(`– Baue Transfer: ${amt} SOL → ${recipient} (${lamports} Lamports)`);

      const tx = new Transaction().add(
        SystemProgram.transfer({ fromPubkey: solPublicKey, toPubkey: recipient, lamports })
      );
      tx.feePayer = solPublicKey;
      try {
        const { blockhash } = await solConnection.getLatestBlockhash('confirmed');
        tx.recentBlockhash = blockhash;
        log(`– recentBlockhash: ${blockhash}`);

        log('– signAndSendTransaction aufrufen');
        const { signature } = await solProvider.signAndSendTransaction(tx, {
          preflightCommitment: 'confirmed'
        });
        log(`✔ signature erhalten: ${signature}`);

        log('– confirmTransaction');
        await solConnection.confirmTransaction(signature, 'confirmed');
        log('🟢 Transaktion bestätigt');
        alert(`✅ Gesendet!\nSignature:\n${signature}`);
      } catch (e) {
        console.error(e);
        log(`✖ Fehler beim Senden: ${e.message || e}`);
        alert('❌ Fehler beim Senden: ' + (e.message || e));
      }
    });
  </script>
</body>
</html>
