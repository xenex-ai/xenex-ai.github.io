<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Solana SEND SOL via WalletConnect</title>

  <!-- 1) Solana Web3.js (IIFE UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.93.0/lib/index.iife.min.js"></script>
  <!-- 2) Wallet Adapter Base (IIFE UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@solana/wallet-adapter-base@0.9.13/lib/index.iife.js"></script>
  <!-- 3) WalletConnect Wallet Adapter (IIFE UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@solana/wallet-adapter-walletconnect@0.1.20/lib/index.iife.js"></script>

  <style>
    body { font-family: sans-serif; margin: 2rem; }
    button, input { margin: .5rem 0; padding: .5rem; font-size: 1rem; }
    #walletInfo { margin: 1rem 0; color: #036; }
  </style>
</head>

<body>
  <h2>Solana WalletConnect & SOL senden</h2>

  <button id="connectBtn">WalletConnect verbinden</button>
  <p id="walletInfo">Nicht verbunden</p>

  <hr/>

  <label for="amount">Anzahl SOL:</label><br/>
  <input id="amount" type="number" step="0.0001" min="0.0001" value="0.01"/><br/>
  <button id="sendBtn" disabled>SEND SOL</button>

  <script>
    (async () => {
      // UMD-Exports
      const {
        Connection,
        PublicKey,
        SystemProgram,
        Transaction,
        LAMPORTS_PER_SOL,
        clusterApiUrl
      } = window.solanaWeb3;

      const { WalletConnectWalletAdapter } = window.walletAdapterWalletconnect;

      // WalletConnect v2 Project ID eintragen
      const adapter = new WalletConnectWalletAdapter({
        network: 'mainnet-beta',
        options: {
          relayUrl: 'wss://relay.walletconnect.com',
          projectId: '262e67d5e1f2205615ff102f60b2f1dc',
          metadata: {
            name: 'Xenex AI DApp',
            description: 'SOL senden per WalletConnect',
            url: 'https://xenexai.com',
            icons: ['https://xenexai.com/favicon.ico']
          }
        }
      });

      // UI-Referenzen
      const connectBtn = document.getElementById('connectBtn');
      const sendBtn    = document.getElementById('sendBtn');
      const info       = document.getElementById('walletInfo');
      const inp        = document.getElementById('amount');

      let connection, publicKey;

      // 1) WalletConnect verbinden
      connectBtn.addEventListener('click', async () => {
        try {
          await adapter.connect();                // Ã¶ffnet QR-Code / Deep-Link
          publicKey  = adapter.publicKey;         // PublicKey des Wallets
          connection = new Connection(
            clusterApiUrl('mainnet-beta'),
            'confirmed'
          );
          info.innerText = `Verbunden: ${publicKey.toString()}`;
          sendBtn.disabled = false;
        } catch (err) {
          console.error(err);
          alert('ðŸ”´ Connect fehlgeschlagen: ' + (err.message || err));
        }
      });

      // 2) SOL senden
      sendBtn.addEventListener('click', async () => {
        const amount = parseFloat(inp.value);
        if (isNaN(amount) || amount <= 0) {
          return alert('Bitte gÃ¼ltige SOL-Menge eingeben.');
        }

        // EmpfÃ¤nger-Adresse und Lamports
        const toPub     = new PublicKey('87rM7pH6PsUQ7zE7458XoD5K7od1heEuv1FyTguxenex');
        const lamports  = Math.round(amount * LAMPORTS_PER_SOL);

        // Transaktion bauen
        const tx = new Transaction().add(
          SystemProgram.transfer({
            fromPubkey: publicKey,
            toPubkey:   toPub,
            lamports:   lamports
          })
        );
        tx.feePayer = publicKey;
        const { blockhash } = await connection.getLatestBlockhash('finalized');
        tx.recentBlockhash = blockhash;

        try {
          // sendTransaction Ã¶ffnet das Wallet-Popup inkl. SOL-Menge
          const signature = await adapter.sendTransaction(tx, connection);
          await connection.confirmTransaction(signature, 'finalized');
          alert(`âœ… Gesendet! Signature:\n${signature}`);
        } catch (err) {
          console.error(err);
          alert('ðŸ”´ Fehler beim Senden: ' + (err.message || err));
        }
      });
    })();
  </script>
</body>
</html>
